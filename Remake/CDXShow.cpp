//
// 파일명 : CDXShow.cpp
// 
// 설명 : CDXShow 클래스의 정의
//
// 김성후(lonkth@naver.com)
// 2010.01.03 최종 수정
//


#include "CDXShow.h"
#pragma warning(disable : 4244)
#pragma warning(disable : 4996)


//////////////////////////////////////////////////////////////////////////////////////////
// CDXShow(), ~CDXShow()
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : 생성자, 소멸자
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

CDXShow::CDXShow(){}

CDXShow::~CDXShow()
{
	if(pControl) pControl->Release();
	pControl=NULL;
	if(pEvent) pEvent->Release();
	pEvent=NULL;
	if(pPosition) pPosition->Release();
	pPosition=NULL;
	if(pVolume) pVolume->Release();
	pVolume=NULL;
	if(pGraph) pGraph->Release();
	pGraph=NULL;
}


//////////////////////////////////////////////////////////////////////////////////////////
// bool Initialize(HWND hWnd, char* FilePath)
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : MP3 파일의 경로와 윈도우 핸들을 인자로 받아와서 초기화 시킨다.
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

bool CDXShow::Initialize(HWND hWnd, char* FilePath)
{
	//유니코드로 변환
	size_t nlen = strlen(FilePath) + 1;
	WCHAR* wFileName = (WCHAR*)malloc(sizeof(WCHAR)*nlen);
	mbstowcs(wFileName, FilePath, nlen);

	CoInitialize(NULL);
	CoCreateInstance(CLSID_FilterGraph, NULL, CLSCTX_INPROC, IID_IGraphBuilder, reinterpret_cast<void **>(&pGraph));
	pGraph->QueryInterface(IID_IMediaControl, reinterpret_cast<void **>(&pControl));
	pGraph->QueryInterface(IID_IMediaEvent, reinterpret_cast<void **>(&pEvent));
	pGraph->QueryInterface(IID_IMediaPosition, reinterpret_cast<void **>(&pPosition));
	pGraph->QueryInterface(IID_IBasicAudio, reinterpret_cast<void **> (&pVolume));
	pGraph->RenderFile(wFileName, NULL);
	return true;
}


//////////////////////////////////////////////////////////////////////////////////////////
// bool Run()
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : MP3 파일을 재생시킨다.
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

bool CDXShow::Run()
{
	pControl->Run();
	return true;
}


//////////////////////////////////////////////////////////////////////////////////////////
// bool Stop()
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : MP3 재생을 정지시킨다.
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

bool CDXShow::Stop()
{
	pControl->Stop();
	pPosition->put_CurrentPosition(0);
	return true;
}


//////////////////////////////////////////////////////////////////////////////////////////
// bool Pause()
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : MP3 재생을 일시정지시킨다.
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

bool CDXShow::Pause()
{
	pControl->Pause();
	return true;
}


//////////////////////////////////////////////////////////////////////////////////////////
// bool SetVolume()
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : MP3 재생볼륨을 설정한다.
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

bool CDXShow::SetVolume(float Volume)
{
	pVolume->put_Volume(100 * Volume - 10000);
	return true;
}


//////////////////////////////////////////////////////////////////////////////////////////
// bool SetBalance()
//////////////////////////////////////////////////////////////////////////////////////////
//
// 설명 : 음향이 재생되는 좌우위치를 설정한다.
//
// 2010.01.03 최종수정
//////////////////////////////////////////////////////////////////////////////////////////

bool CDXShow::SetBalance(float Balance)
{
	pVolume->put_Balance(100 * Balance);
	return true;
}